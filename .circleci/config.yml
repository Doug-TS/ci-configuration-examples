version: 2.1
orbs:
  matlab: mathworks/matlab@1
jobs:
  build:
    machine:
      image: ubuntu-2204:current
    environment:
      MATLAB_LOG_DIR: /home/circleci/project/logs
      MW_DIAGNOSTIC_DEST: file
      MW_DIAGNOSTIC_SPEC: cppmicroservices::framework.*=all;install.*=all;
      MW_VERBOSE_HTTPCLIENT_CORE: 1
      MW_BATCH_LICENSING_ONLINE: true  # testing online validation, can remove when this becomes the default
    steps:
      - checkout
      # Use AWS-based Ubuntu mirror for better connectivity.
      # See https://support.circleci.com/hc/en-us/articles/37474192881179-Resolving-Unable-to-connect-to-archive-ubuntu-com-403-Forbidden-Error-in-CircleCI
      - run:
          name: Switch to AWS mirror
          command: |
            sudo sed -i 's|http://archive.ubuntu.com|http://us-east-1.ec2.archive.ubuntu.com|g' /etc/apt/sources.list
            sudo sed -i 's|http://security.ubuntu.com|http://us-east-1.ec2.archive.ubuntu.com|g' /etc/apt/sources.list
      # Make APT more robust to network connectivity issues.
      - run:
          name: Configure APT behavior
          command: |
            echo 'Acquire::ForceIPv4 "true";' | sudo tee /etc/apt/apt.conf.d/99force-ipv4
            echo 'Acquire::http::Timeout "30";' | sudo tee /etc/apt/apt.conf.d/99timeout
            echo 'Acquire::Retries "3";' | sudo tee /etc/apt/apt.conf.d/99retries
            echo 'Acquire::http::Pipeline-Depth "0";' | sudo tee /etc/apt/apt.conf.d/99pipeline
      - matlab/install:
          products: Optimization_Toolbox Curve_Fitting_Toolbox
      - matlab/run-tests:
          source-folder: code
      - run:
          command: tar -cvzf matlab-logs.tar /home/circleci/project/logs
          when: on_fail
      - store_artifacts: 
          path: matlab-logs.tar
          when: on_fail

      # As an alternative to run-tests, you can use run-command to execute a MATLAB script, function, or statement.
      # - matlab/run-command:
      #     command: addpath('code'); results = runtests('IncludeSubfolders', true); assertSuccess(results);
